<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="project">

	<select id="getLouPanMaxCode" resultType="java.lang.String">
		select lpcode from dz_loupan order by lpcode desc LIMIT 1
	</select>

	<select id="getLouPanCount" parameterType="Map" resultType="java.lang.String">
		select count(id) from dz_loupan
		<where>
			<if test="name!=null and name!=''">and name like '%${name}%' </if>
			<if test="type!=null and type!=''">and propertytype like '%${type}%' </if>
		</where>
	</select>
	<select id="getLouPanList" parameterType="Map" resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan
		<where>
			<if test="name!=null and name!=''">and name like '%${name}%' </if>
			<if test="type!=null and type!=''">and propertytype like '%${type}%' </if>
		</where>
		 order by  ${orderby}
		 limit #{start_num,,jdbcType=INTEGER},#{page_size,,jdbcType=INTEGER}
	</select>
	<select id="getLouPanAllList" parameterType="Map"
		resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan
		<where>
			<if test="name!=null">and name like '%${name}%' </if>
		</where>
	</select>
	<select id="getLouPanById" parameterType="Map" resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan where id=#{id}
	</select>
	<insert id="insertLouPan" parameterType="com.deya.project.dz_house.LouPanBean">
		insert into
		dz_loupan(lpcode,name,tel,coordinate,address,opentime,developers,ckdj,property,propertytype,jzlx,zxzk,remark,yszh,zts,wyf,lhl,rjl,cwbl,tdsynx,jzjg,jzmj,zdmj,sgdw)
		values(#{lpcode},#{name},#{tel},#{coordinate},#{address},#{opentime},#{developers},#{ckdj},#{property},#{propertytype},#{jzlx},#{zxzk},#{remark},#{yszh},#{zts},#{wyf},#{lhl},#{rjl},#{cwbl},#{tdsynx},#{jzjg},#{jzmj},#{zdmj},#{sgdw})
	</insert>
	<update id="updateLouPan" parameterType="com.deya.project.dz_house.LouPanBean">
		update dz_loupan set name = #{name},tel=#{tel},coordinate = #{coordinate},address=#{address},opentime=#{opentime},developers=#{developers},ckdj=#{ckdj},property=#{property},
		propertytype=#{propertytype},jzlx=#{jzlx},zxzk=#{zxzk},remark=#{remark},yszh=#{yszh},zts=#{zts},wyf=#{wyf},lhl=#{lhl},
		rjl=#{rjl},cwbl=#{cwbl},tdsynx=#{tdsynx},jzjg=#{jzjg},jzmj=#{jzmj},zdmj=#{zdmj},sgdw=#{sgdw} where id = #{id}
	</update>
	<delete id="deleteLouPan" parameterType="Map">
		delete from dz_loupan where id=#{id}
	</delete>


	<select id="getCountList" resultType="com.deya.project.dz_house.HouseCountBean">
		SELECT
			t1.*
		FROM
			(
				SELECT
					l.`name`,
					IFNULL(h.codes, 0) AS codes,
					IFNULL(h.nums, 0) AS nums,
					IFNULL(h.jzmj, 0) AS jzmj,
					IFNULL(h.symj, 0) AS symj,
					IFNULL(h.ysnums, 0) AS ysnums,
					IFNULL(h.ysjzmj, 0) AS ysjzmj,
					IFNULL(h.yssymj, 0) AS yssymj,
					IFNULL(h.wsnum, 0) AS wsnums,
					IFNULL(h.wsjzmj, 0) AS wsjzmj,
					IFNULL(h.wssymj, 0) AS wssymj
				FROM
					dz_loupan l
				LEFT JOIN (
					SELECT
						c.*, d.wsnum,
						d.wsjzmj,
						d.wssymj
					FROM
						(
							SELECT
								a.*, b.ysnums,
								b.ysjzmj,
								b.yssymj
							FROM
								(
									SELECT
										substring(house.housecode, 1, 2) AS codes,
										count(house.id) AS nums,
										sum(house.jzmj) AS jzmj,
										sum(house.symj) AS symj
									FROM
										dz_house house
									GROUP BY
										substring(house.housecode, 1, 2)
								) a
							LEFT JOIN (
								SELECT
									substring(house.housecode, 1, 2) AS codes,
									count(house.id) AS ysnums,
									sum(house.jzmj) AS ysjzmj,
									sum(house.symj) AS yssymj
								FROM
									dz_house house
								WHERE
									house.fjzt = '已售'
								GROUP BY
									substring(house.housecode, 1, 2)
							) b ON a.codes = b.codes
						) c
					LEFT JOIN (
						SELECT
							substring(house.housecode, 1, 2) AS codes,
							count(house.id) AS wsnum,
							sum(house.jzmj) AS wsjzmj,
							sum(house.symj) AS wssymj
						FROM
							dz_house house
						WHERE
							house.fjzt = '未售'
						GROUP BY
							substring(house.housecode, 1, 2)
					) d ON c.codes = d.codes
				) h ON l.lpcode = h.codes
				ORDER BY
					l.lpcode
			) t1
		UNION ALL
			SELECT
				'合计' AS `name`,
				'99' AS codes,
				sum(t.nums) AS nums,
				sum(t.jzmj) AS jzmj,
				sum(t.symj) AS symj,
				sum(t.ysnums) AS ysnums,
				sum(t.ysjzmj) AS ysjzmj,
				sum(t.yssymj) AS yssymj,
				sum(t.wsnums) AS wsnums,
				sum(t.wsjzmj) AS wsjzmj,
				sum(t.wssymj) AS wssymj
			FROM
				(
					SELECT
						IFNULL(h.nums, 0) AS nums,
						IFNULL(h.jzmj, 0) AS jzmj,
						IFNULL(h.symj, 0) AS symj,
						IFNULL(h.ysnums, 0) AS ysnums,
						IFNULL(h.ysjzmj, 0) AS ysjzmj,
						IFNULL(h.yssymj, 0) AS yssymj,
						IFNULL(h.wsnum, 0) AS wsnums,
						IFNULL(h.wsjzmj, 0) AS wsjzmj,
						IFNULL(h.wssymj, 0) AS wssymj
					FROM
						dz_loupan l
					LEFT JOIN (
						SELECT
							c.*, d.wsnum,
							d.wsjzmj,
							d.wssymj
						FROM
							(
								SELECT
									a.*, b.ysnums,
									b.ysjzmj,
									b.yssymj
								FROM
									(
										SELECT
											substring(house.housecode, 1, 2) AS codes,
											count(house.id) AS nums,
											sum(house.jzmj) AS jzmj,
											sum(house.symj) AS symj
										FROM
											dz_house house
										GROUP BY
											substring(house.housecode, 1, 2)
									) a
								LEFT JOIN (
									SELECT
										substring(house.housecode, 1, 2) AS codes,
										count(house.id) AS ysnums,
										sum(house.jzmj) AS ysjzmj,
										sum(house.symj) AS yssymj
									FROM
										dz_house house
									WHERE
										house.fjzt = '已售'
									GROUP BY
										substring(house.housecode, 1, 2)
								) b ON a.codes = b.codes
							) c
						LEFT JOIN (
							SELECT
								substring(house.housecode, 1, 2) AS codes,
								count(house.id) AS wsnum,
								sum(house.jzmj) AS wsjzmj,
								sum(house.symj) AS wssymj
							FROM
								dz_house house
							WHERE
								house.fjzt = '未售'
							GROUP BY
								substring(house.housecode, 1, 2)
						) d ON c.codes = d.codes
					) h ON l.lpcode = h.codes
					ORDER BY
						l.lpcode
				) t
	</select>
</mapper>