<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="project">

	<select id="getLouPanMaxCode" resultType="java.lang.String">
		select lpcode from dz_loupan order by lpcode desc LIMIT 1
	</select>

	<select id="getLouPanCount" parameterType="Map" resultType="java.lang.String">
		select count(id) from dz_loupan
		<where>
			<if test="name!=null and name!=''">and name like '%${name}%' </if>
		</where>
	</select>
	<select id="getLouPanList" parameterType="Map" resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan
		<where>
			<if test="name!=null and name!=''">and name like '%${name}%' </if>
		</where>
		 order by  ${orderby}
		 limit #{start_num,,jdbcType=INTEGER},#{page_size,,jdbcType=INTEGER}
	</select>
	<select id="getLouPanAllList" parameterType="Map"
		resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan
		<where>
			<if test="name!=null">and name like '%${name}%' </if>
		</where>
	</select>
	<select id="getLouPanById" parameterType="Map" resultType="com.deya.project.dz_house.LouPanBean">
		select * from dz_loupan where id=#{id}
	</select>
	<insert id="insertLouPan" parameterType="com.deya.project.dz_house.LouPanBean">
		insert into
		dz_loupan(lpcode,name,tel,coordinate,address,opentime,developers,property,propertytype,jzlx,zxzk,remark,yszh,zts,wyf,lhl,rjl,cwbl,tdsynx,jzjg,jzmj,zdmj,sgdw)
		values(#{lpcode},#{name},#{tel},#{coordinate},#{address},#{opentime},#{developers},#{property},#{propertytype},#{jzlx},#{zxzk},#{remark},#{yszh},#{zts},#{wyf},#{lhl},#{rjl},#{cwbl},#{tdsynx},#{jzjg},#{jzmj},#{zdmj},#{sgdw})
	</insert>
	<update id="updateLouPan" parameterType="com.deya.project.dz_house.LouPanBean">
		update dz_loupan set name = #{name},tel=#{tel},coordinate = #{coordinate},address=#{address},opentime=#{opentime},developers=#{developers},property=#{property},
		propertytype=#{propertytype},jzlx=#{jzlx},zxzk=#{zxzk},remark=#{remark},yszh=#{yszh},zts=#{zts},wyf=#{wyf},lhl=#{lhl},
		rjl=#{rjl},cwbl=#{cwbl},tdsynx=#{tdsynx},jzjg=#{jzjg},jzmj=#{jzmj},zdmj=#{zdmj},sgdw=#{sgdw} where id = #{id}
	</update>
	<delete id="deleteLouPan" parameterType="Map">
		delete from dz_loupan where id=#{id}
	</delete>


	<select id="getCountList" resultType="com.deya.project.dz_house.HouseCountBean">
		select
			l.`name`,
			IFNULL(h.codes,0) as codes,
			IFNULL(h.nums,0) as nums,
			IFNULL(h.jzmj,0) as jzmj,
			IFNULL(h.symj,0) as symj,
			IFNULL(h.ysnums,0) as ysnums,
			IFNULL(h.ysjzmj,0) as ysjzmj,
			IFNULL(h.yssymj,0) as yssymj,
			IFNULL(h.wsnum,0) as wsnums,
			IFNULL(h.wsjzmj,0) as wsjzmj,
			IFNULL(h.wssymj,0) as wssymj
		from
			dz_loupan l
		left join (
			select
				c.*, d.wsnum,
				d.wsjzmj,
				d.wssymj
			from
				(
					select
						a.*, b.ysnums,
						b.ysjzmj,
						b.yssymj
					from
						(
							select
								substring(house.housecode, 1, 2) as codes,
								count(house.id) as nums,
								sum(house.jzmj) as jzmj,
								sum(house.symj) as symj
							from
								dz_house house
							group by
								substring(house.housecode, 1, 2)
						) a
					left join (
						select
							substring(house.housecode, 1, 2) as codes,
							count(house.id) as ysnums,
							sum(house.jzmj) as ysjzmj,
							sum(house.symj) as yssymj
						from
							dz_house house
						where
							house.fjzt = '已售'
						group by
							substring(house.housecode, 1, 2)
					) b on a.codes = b.codes
				) c
			left join (
				select
					substring(house.housecode, 1, 2) as codes,
					count(house.id) as wsnum,
					sum(house.jzmj) as wsjzmj,
					sum(house.symj) as wssymj
				from
					dz_house house
				where
					house.fjzt = '未售'
				group by
					substring(house.housecode, 1, 2)
			) d on c.codes = d.codes
		) h on l.lpcode = h.codes
		order by
			l.lpcode
	</select>
</mapper>