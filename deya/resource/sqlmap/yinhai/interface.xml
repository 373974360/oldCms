<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
        "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="interface">

    <!-- *****************根据渠道信息获取每个栏目的信息发布和信息访问统计******************* -->
    <select id="getPublishSource" resultType="Map">
        SELECT DISTINCT
          publish_source
        FROM
          cs_info
    </select>



    <!-- *****************根据渠道信息获取每个栏目的信息发布和信息访问统计******************* -->
    <select id="getVisitCount" parameterType="Map" resultType="com.yinhai.model.InfoCount">


        SELECT
        c.id                                                                                   AS catId,
        c.cat_cname                                                                            AS colname,
        c.cat_sort                                                                             AS sortno,
        (SELECT ifnull(sum(hits), 0)
        FROM cs_info
        WHERE cat_id IN (
        SELECT y.id
        FROM cs_info_category y LEFT JOIN dz_cdgjj_source_info_category s ON s.cat_id = y.cat_id
        WHERE y.cat_position LIKE concat(c.cat_position, '%') AND s.source = #{publish_source}
        )  <if test="date != null">
        and released_dtime &lt;= #{date}
    </if>
        AND info_status = 8 AND final_status = 0)                                       AS tvisitnum,
        (SELECT ifnull(sum(day_hits), 0)
        FROM cs_info
        WHERE cat_id IN (
        SELECT y.id
        FROM cs_info_category y LEFT JOIN dz_cdgjj_source_info_category s ON s.cat_id = y.cat_id
        WHERE y.cat_position LIKE concat(c.cat_position, '%') AND s.source = #{publish_source}
        )
        <if test="today != null">
            and released_dtime LIKE #{today}
        </if> AND info_status = 8 AND final_status = 0) AS visitnum,
        (SELECT ifnull(count(*), 0)
        FROM cs_info
        WHERE cat_id IN (
        SELECT y.id
        FROM cs_info_category y LEFT JOIN dz_cdgjj_source_info_category s ON s.cat_id = y.cat_id
        WHERE y.cat_position LIKE concat(c.cat_position, '%') AND s.source = #{publish_source}
        ) <if test="date != null">
        and released_dtime &lt;= #{date}
    </if> AND info_status = 8 AND final_status = 0)                          AS tpubnum,
        (SELECT ifnull(count(*), 0)
        FROM cs_info
        WHERE cat_id IN (
        SELECT y.id
        FROM cs_info_category y LEFT JOIN dz_cdgjj_source_info_category s ON s.cat_id = y.cat_id
        WHERE y.cat_position LIKE concat(c.cat_position, '%') AND s.source = #{publish_source}
        ) <if test="today != null">
        and released_dtime LIKE #{today}
    </if> AND info_status = 8 AND final_status = 0)                         AS pubnum
        FROM cs_info_category c
        WHERE c.parent_id = 0 AND c.site_id LIKE 'CMS%'
        ORDER BY c.cat_id ASC
    </select>

    <!-- 统计访问量排行前十条信息 -->
    <select id="getHotInfoList" parameterType="Map" resultType="Map">
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info where <![CDATA[ rownum <= 10 ]]>
        and site_id like 'CMS%'
        <if test="start_day != null"><![CDATA[ and released_dtime >= #{start_day}]]></if>
        <if test="end_day != null"><![CDATA[ and released_dtime <= #{end_day}]]></if>
        order by hits desc
    </select>

    <select id="getHotInfoList_mysql" parameterType="Map" resultType="Map">
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info where site_id like 'CMS%'
        <if test="start_day != null"><![CDATA[ and released_dtime >= #{start_day}]]></if>
        <if test="end_day != null"><![CDATA[ and released_dtime <= #{end_day}]]></if>
        order by hits desc limit 0,10
    </select>

    <select id="getHotInfoList_mssql" parameterType="Map" resultType="Map">
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info where site_id like 'CMS%'
        <if test="start_day != null"><![CDATA[ and released_dtime >= #{start_day}]]></if>
        <if test="end_day != null"><![CDATA[ and released_dtime <= #{end_day}]]></if>
        order by hits desc
    </select>

    <!-- 根据父栏目id获取子栏目信息 -->
    <select id="getCategoryByParentId" parameterType="Map" resultType="Map">
        select c.cat_cname,c.cat_id from cs_info_category c LEFT JOIN dz_cdgjj_source_info_category s on s.cat_id = c.cat_id where 1=1
        <if test="colid != null"> and c.parent_id = #{colid}</if>
        <if test="source != null"> and s.source = #{source}</if>

    </select>

    <!-- 根据栏目id查找该栏目下的信息 -->
    <select id="getInfoListByCatId" parameterType="Map" resultType="Map">
        select * from (
        select row_.*, rownum rownum_ from (
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info
        where info_status = 8 and final_status = 0 and site_id like 'CMS%'
        <if test="cat_id != null">and cat_id = #{cat_id}</if>
        <if test="publish_source != null">and publish_source like #{publish_source}</if>
        order by released_dtime desc
        <![CDATA[
		        ) row_ where rownum <=#{limit,,jdbcType=INTEGER}+#{start,,jdbcType=INTEGER}
	    	) where rownum_ >=#{start,,jdbcType=INTEGER} + 1
	    ]]>

    </select>

    <select id="getInfoListCountByCatId" parameterType="Map" resultType="java.lang.String">
        select count(*) total from cs_info
        where info_status = 8 and final_status = 0 and site_id like 'CMS%'
        <if test="cat_id != null">and cat_id = #{cat_id}</if>
        <if test="publish_source != null">and publish_source like #{publish_source}</if>
    </select>

    <select id="getInfoListByCatId_mysql" parameterType="Map"
            resultType="Map">
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info
        where info_status = 8 and final_status = 0 and site_id like 'CMS%'
        <if test="cat_id != null">and cat_id = #{cat_id}</if>
        <if test="publish_source != null">and publish_source like #{publish_source}</if>
        order by released_dtime desc limit #{start,,jdbcType=INTEGER},#{limit,,jdbcType=INTEGER}
    </select>

    <select id="getInfoListByCatId_mssql" parameterType="Map"
            resultType="Map">
        select
        info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime from
        cs_info
        where info_status = 8 and final_status = 0 and site_id like 'CMS%'
        <if test="cat_id != null">and cat_id = #{cat_id}</if>
        <if test="publish_source != null">and publish_source like #{publish_source}</if>
        order by released_dtime desc
    </select>

    <!-- 根据信息id获取信息内容 -->
    <select id="getInfoContentByInfoId" parameterType="Map"
            resultType="Map">
        select
        info.info_id,title,subtitle,top_title,author,editor,source,hits,input_dtime,thumb_url,content_url,released_dtime,art.info_content from
        cs_info info left join cs_info_article art on info.info_id = art.info_id
        where info.info_id = #{info_id}
    </select>

</mapper>
